---
title: "BurpSuiteã¨Fridaã®æ©‹æ¸¡ã—ã€ŒBridaã€ã®ç´¹ä»‹"
emoji: "ğŸŒŸ"
type: "tech" # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics: ["BurpSuite", "Frida", "Security"]
published: false
---

ã“ã®è¨˜äº‹ã¯ã€ [DeNA 21æ–°å’Ã—22æ–°å’å†…å®šè€… Advent Calendar 2021](https://qiita.com/advent-calendar/2020/dena-21-shinsotsu) ã®15æ—¥ç›®ã®æŠ•ç¨¿ã§ã™ã€‚Brida ã¨ã„ã†ã‚½ãƒ•ãƒˆã®è§£èª¬ã‚’ Android ã‚¢ãƒ—ãƒªã‚’å®Ÿç”¨çš„ãªä¾‹ã¨ã—ã¦æŒ™ã’ã¦è¡Œã„ã¾ã™ã€‚

# Bridaã¨ã¯
> Brida is a Burp Suite Extension that, working as a bridge between Burp Suite and Frida, lets you use and manipulate applicationsâ€™ own methods while tampering the traffic exchanged between the applications and their back-end services/servers. It supports all platforms supported by Frida (Windows, macOS, Linux, iOS, Android, and QNX).
ï¼ˆ[Brida](https://github.com/federicodotta/Brida)ã‚ˆã‚Šå¼•ç”¨ï¼‰

æ–‡å­—é€šã‚Š HTTP é€šä¿¡ã®è¨˜éŒ²ã‚’è¡Œã† [Burp Suite](https://portswigger.net/burp) ã®æ‹¡å¼µã§ã€ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³å±¤ã«ã‚ˆã‚‹ç‹¬è‡ªæš—å·åŒ–ç­‰ã«å¯¾ã—ã¦ã‚‚ HTTP é€šä¿¡ã«å¯¾å¿œã§ãã‚‹ã‚ˆã†ã«ã™ã‚‹ã€ã¨ã„ã†ã‚‚ã®ã§ã™ã€‚ãã®éš›ã« [Frida](https://frida.re/) ã¨ã„ã†å‹•çš„è§£æãƒ»æ”¹ã–ã‚“ãƒ„ãƒ¼ãƒ«ã‚’ç”¨ã„ã‚‹ã“ã¨ã§ã€Burp Suite ã«è¿½åŠ æƒ…å ±ã‚’ä»˜ä¸ã—ã¾ã™ã€‚

# å°å…¥æ–¹æ³•
ä»¥ä¸‹ã®ã‚‚ã®ãŒå¿…è¦ã§ã™ã€‚ãªãŠã€ã“ã®è¨˜äº‹ã§ã¯v0.4ã®ã‚‚ã®ã‚’å°å…¥ã—ã¦ã„ã¾ã™ãŒã€åŸ·ç­†æ™‚ç‚¹ã§Githubä¸Šã«ã¦v0.5ãŒãƒªãƒªãƒ¼ã‚¹ã•ã‚Œã¦ãŠã‚Šã¾ã™ã€‚ãã¡ã‚‰ã‚’ä½¿ã†å ´åˆã€å„ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã«å¤‰æ›´ãŒã‚ã‚‹ã®ã§ã€é©åˆ‡ãªãƒãƒ¼ã‚¸ãƒ§ãƒ³ã§ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã‚’è¡Œã£ã¦ãã ã•ã„ã€‚

- Burp Suite (1.X or 2.X)
  - ä¸€åº¦èµ·å‹•ã—ãŸã‚‰ Extender > BApp Store > Search ã‚ˆã‚Šã€ŒBridaã€ã§æ¤œç´¢ã—ã¦ã€Brida ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã—ã¾ã—ã‚‡ã†ã€‚
- Frida client

```bash
$ pip install frida-tools
```
- Pyro4 (Pyro5 ã«ã¯å¯¾å¿œã—ã¦ãªã•ãã†ã§ã™ï¼‰

```bash
$ pip install Pyro4
```
- frida-compile
  - ã“ã®è¨˜äº‹ã®åŸ·ç­†æ™‚ç‚¹ã§ã¯ã€frida-compile 10 ã« Brida ãŒè¿½ã„ã¤ã„ã¦ãŠã‚‰ãšã€[issue](https://github.com/federicodotta/Brida/issues/67) ã«ãªã£ã¦ã„ã¾ã™ã€‚ãã®ãŸã‚ã€frida-compile 9 ã‚’åˆ©ç”¨ã—ã¾ã™ã€‚
  - ã¾ãŸã€node ã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã«ã‚ˆã£ã¦ã¯å‹•ä½œã—ãªã„å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ï¼ˆ[é–¢é€£Issue](https://github.com/federicodotta/Brida/issues/77)ï¼‰ä»Šå›ã¯13.12.0ã‚’åˆ©ç”¨ã—ã¦ã¾ã™ã€‚

```bash
$ npm install -g frida-compile@9.5.2
```
- Frida ServerãŒå®Ÿè¡Œã§ãã‚‹ç’°å¢ƒã¨å¯¾è±¡ã®ã‚½ãƒ•ãƒˆ
  - Android ã‚’ä¾‹ã«ã™ã‚‹ã¨ã€Root æ¨©é™ã‚’å–ã‚‹ã“ã¨ã§ frida-server ãŒå‹•ãã€ã‚‚ã—ãã¯ã‚¢ãƒ—ãƒªã« Frida Gadget ã‚’åŸ‹ã‚è¾¼ã‚“ã§ã„ã‚‹çŠ¶æ…‹ã‚’æŒ‡ã—ã¾ã™ã€‚

# æ¤œè¨¼ç’°å¢ƒã®ä½œæˆ
ã‚µãƒ¼ãƒãƒ¼ã¯ Goã€ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã¯ Kotlin ã‚’ç”¨ã„ãŸ Android Native ã§ AES-GCM ã§æš—å·åŒ–ã•ã‚ŒãŸé€šä¿¡ã‚’ã™ã‚‹æ¤œè¨¼ç’°å¢ƒã‚’ä½œæˆã—ã¾ã—ãŸã€‚ä»¥ä¸‹ãã®ã‚³ãƒ¼ãƒ‰ï¼ˆã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã¯æ¦‚è¦ï¼‰ã§ã™ã€‚ã‚¬ãƒã‚¬ãƒç’°å¢ƒã§ã™ãŒã€ã‚½ãƒ¼ã‚¹ã‚³ãƒ¼ãƒ‰ã¯ [Github](https://github.com/fiord/Encrypted-Connection-Sample) ã«ã‚ã‚Šã¾ã™ã€‚

```go:main.go
package main

import (
  "crypto/aes"
  "crypto/cipher"
  "crypto/rand"
  "encoding/base64"
  "fmt"
  "io"
  "os"
  "net/http"
  "github.com/gin-gonic/gin"
)


// cipher
var KEY = []byte("FLAG{5ecret_ke4}")

func encrypt(s string) (string, error) {
  c, err := aes.NewCipher(KEY)
  if err != nil {
    return "", err
  }

  gcm, err := cipher.NewGCM(c)
  if err != nil {
    return "", err
  }

  nonce := make([]byte, gcm.NonceSize())
  if _, err = io.ReadFull(rand.Reader, nonce); err != nil {
    return "", err
  }

  out := gcm.Seal(nonce, nonce, []byte(s), nil)
  out_enc := base64.StdEncoding.EncodeToString(out)
  return out_enc, err
}

func decrypt(param_name string) ([]byte, error) {
  enc_name_byte, err := base64.StdEncoding.DecodeString(param_name)
  if err != nil {
    return []byte{}, err
  }

  c, err := aes.NewCipher(KEY)
  if err != nil {
    return []byte{}, err
  }

  gcm, err := cipher.NewGCM(c)
  if err != nil {
    return []byte{}, err
  }

  nonceSize := gcm.NonceSize()
  if len(enc_name_byte) < nonceSize {
    return []byte{}, fmt.Errorf("too short param")
  }

  nonce, cipherText := enc_name_byte[:nonceSize], enc_name_byte[nonceSize:]
  plain, err := gcm.Open(nil, nonce, cipherText, nil)
  if err != nil {
    return []byte{}, err
  }

  return plain, err
}

func main() {

  // web server
  r := gin.Default()

  r.POST("/greet", func(c *gin.Context) {
    param_name := c.PostForm("name")
    decrypted, err := decrypt(param_name)
    if err != nil {
      c.String(http.StatusBadRequest, err.Error())
      return
    }

    res := []byte(fmt.Sprintf("Hello, %s!", decrypted))

    enc, err := encrypt(string(res))
    if err != nil {
      c.String(http.StatusBadRequest, err.Error())
      return
    }

    c.String(http.StatusOK, enc)
  })

  r.GET("/", func(c *gin.Context) {
    c.String(http.StatusOK, "Hello, World!")
  })

  port := os.Getenv("PORT")
  if port == "" {
    port = "8080"
  }

  if err := r.Run(":" + port); err != nil {
    panic(err)
  }
}
```

Go ã¯ Gin ã‚’ç”¨ã„ã¦ã€`POST /greet` ã® `name` ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã«ã‚ã‚‹å†…å®¹ãŒ AES-GCM ã§æš—å·åŒ–ã•ã‚Œã¦ã„ã‚‹ã¨ã„ã†å‰æã®å…ƒã€å¾©å·ãƒ»ç‰¹å®šã®æ–‡å­—åˆ—ã‚’è¿½åŠ ã—ã¦å†åº¦æš—å·åŒ–ã—ã¦è¿”ã—ã¦ã„ã¾ã™ã€‚

```kotlin:LoginDataSource.kt
package dev.fiord.encrypted_communication_sample.data

import android.util.Base64
import android.util.Log
import com.example.client.data.model.LoggedInUser
import com.example.client.io.AppNetwork
import java.io.IOException
import java.lang.Exception
import java.nio.charset.StandardCharsets
import java.util.*
import javax.crypto.Cipher
import javax.crypto.SecretKey
import javax.crypto.spec.GCMParameterSpec
import javax.crypto.spec.SecretKeySpec

/**
 * Class that handles authentication w/ login credentials and retrieves user information.
 */
class LoginDataSource {
    private fun encrypt(username: String): String {
        try {
            val decodedKey = KEY.toByteArray(StandardCharsets.UTF_8)
            val key: SecretKey = SecretKeySpec(decodedKey, "AES")
            val cipher = Cipher.getInstance("AES_128/GCM/NoPadding")
            cipher.init(Cipher.ENCRYPT_MODE, key)
            val iv = cipher.iv.copyOf()
            if (iv.size != GCM_NONCE_SIZE) {
                Log.w("encrypt", "nonce size is different. expected: ${GCM_NONCE_SIZE}, actual: ${iv.size}")
            }
            val param = username.toByteArray(StandardCharsets.UTF_8)
            val cipherText = cipher.doFinal(param) // cipherText + tag
            if (cipherText.size != username.length + GCM_TAG_LENGTH) {
                Log.w("encrypt", "cipherText + TAG length is different. expected: ${username.length + GCM_TAG_LENGTH}, actual: ${cipherText.size}")
            }
            return Base64.encodeToString(iv + cipherText, Base64.NO_WRAP)
        } catch (e: Exception) {
            Log.e("encrypt", e.toString())
            throw e
        }
    }

    private fun decrypt(response: String): String {
        try {
            val decodedKey = KEY.toByteArray(StandardCharsets.UTF_8)
            val key: SecretKey =
                SecretKeySpec(decodedKey, "AES")
            val cipher = Cipher.getInstance("AES_128/GCM/NoPadding")
            val param: ByteArray =
                Base64.decode(response.toByteArray(Charsets.UTF_8), Base64.NO_WRAP)
            val iv = param.copyOfRange(0, GCM_NONCE_SIZE)
            val encrypted = param.copyOfRange(GCM_NONCE_SIZE, param.size)

            val spec = GCMParameterSpec(GCM_TAG_LENGTH * 8, iv)
            cipher.init(Cipher.DECRYPT_MODE, key, spec)

            val plainText = cipher.doFinal(encrypted)
            return String(plainText, Charsets.UTF_8)
        } catch (e: Exception) {
            Log.e("decrypt", e.toString())
            throw e
        }
    }

    fun login(username: String?): Result<LoggedInUser> {
        return try {
            var username = username ?: "test_user"
            val encrypted = encrypt(username)
            val response = AppNetwork.greetPost(encrypted)
            Log.v("login", "response: ${response}")
            val decrypted = decrypt(response)
            val fakeUser = LoggedInUser(
                UUID.randomUUID().toString(),
                decrypted
            )
            Result.success<LoggedInUser>(fakeUser)
        } catch (e: Exception) {
            Result.failure<LoggedInUser>(IOException("Error logging in", e))
        }
    }

    companion object {
        private const val AES_KEY_SIZE = 16
        private const val GCM_NONCE_SIZE = 12
        private const val GCM_TAG_LENGTH = 16
        private const val KEY = "FLAG{5ecret_ke4}"
    }
}
```

```kotlin:AppNetwork.kt
package com.example.client.io

import android.util.Log
import okhttp3.FormBody
import okhttp3.OkHttpClient
import okhttp3.Request
import java.lang.Exception

class AppNetwork {
     companion object {
         fun greetPost(encryptedName: String): String {
             try {
                 Log.d("Network", "send name: ${encryptedName}")

                 val client = OkHttpClient()
                 val req = Request.Builder().apply {
                     url("${SERVER_HOST}/greet")
                     post(FormBody.Builder()
                         .add("name", encryptedName)
                         .build())
                 }.build()

                 client.newCall(req).execute().use {
                     val str = it.body?.string()
                     Log.d("Network", "response: ${str}")
                     return str!!
                 }
             } catch (e: Exception) {
                 Log.e("AppNetwork", e.toString())
                 throw e
             }
         }
    }
}
```

ä¸€æ–¹ã€ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã‚µã‚¤ãƒ‰ï¼ˆAndroid Studioã®Login Templateã‚’æµç”¨ã—ã¦ã¾ã™ï¼‰ã§ã¯å…¥åŠ›ã§å—ã‘å–ã£ãŸãƒ•ã‚©ãƒ¼ãƒ ã‚’ AES-GCM ã§æš—å·åŒ–ã—ã¦ `POST /greet` ã«é€ä¿¡ã€å—ã‘å–ã£ãŸå†…å®¹ã‚’å¾©å·ã—ã¦ Toast ã«å‡ºåŠ›ã—ã¾ã™ã€‚

# æ¤œè¨¼ç’°å¢ƒã§ã® Brida ã®æ¤œè¨¼
### ç’°å¢ƒã®è©³ç´°
- å®Ÿè¡Œã™ã‚‹ Android: Android Emulatorï¼ˆæ³¨æ„: x86\_64 ã§æ¤œè¨¼ã—ã¦ã„ã¾ã™ï¼‰
  - [Magisk](https://github.com/topjohnwu/Magisk) ã«ã‚ˆã£ã¦ Root æ¨©é™ã‚’æŒã£ã¦ãŠã‚Šã€[MagiskFrida](https://github.com/AeonLucid/MagiskFrida) ã‚’å†…éƒ¨ã§å‹•ã‹ã—ã¦å¸¸æ™‚ Frida Server ãŒå‹•ã„ã¦ã„ã‚‹çŠ¶æ…‹ã«ã—ã¦ã„ã¾ã™ã€‚
  - ã“ã‚Œã‚’è¡Œã‚ãªã„å ´åˆã€Frida Gadget ã‚’ç”¨ã„ã¦ Frida ãŒã‚¢ãƒ—ãƒªã§èµ·å‹•ã™ã‚‹ã‚ˆã†ã«ã—ã¦ãŠãã¾ã—ã‚‡ã†ã€‚
- ã‚µãƒ¼ãƒãƒ¼ã¯ heroku ã«ä¸Šã’ã¦ãŠãã¾ã™ã€‚
- Android Emulator ã®ãƒ›ã‚¹ãƒˆã¯ Frida ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã—ã¦ãŠãã¾ã—ã‚‡ã†ï¼ˆfrida-tools ã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã§å…¥ã£ã¦ã„ã‚‹ã¯ãšã§ã™ï¼‰

### Brida ç„¡ã—ã®å ´åˆ
ã¾ãšã€Brida æŠœãã§ã©ã†ãªã‚‹ã‹ã‚’ç¢ºèªã—ã¾ã™ã€‚Android ã‹ã‚‰ã®é€šä¿¡ãŒ Burp Suite ã‚’çµŒç”±ã™ã‚‹ã‚ˆã†ã« Androidã€Burp Suite ä¸¡è€…ã®è¨­å®šã‚’è¡Œã„ã¾ã™ã€‚

- Burp Suite: ãƒ›ã‚¹ãƒˆã§ Burp Suite ã‚’èµ·å‹•ã—ã€ 8080 ç•ªãƒãƒ¼ãƒˆã§é€éãƒ—ãƒ­ã‚­ã‚·ã‚’è¨±å¯ã—ãŸçŠ¶æ…‹ã«ã—ã¾ã™ã€‚
- Android: Root æ¨©é™ãŒã‚ã‚‹å ´åˆã€iptablesãŒä½¿ãˆã‚‹ã®ã§ä»¥ä¸‹ã®ã‚³ãƒ¼ãƒ‰ã‚’å®Ÿè¡Œã—ã¾ã™ã€‚ã“ã‚Œã«ã‚ˆã‚Šã€Android ã‹ã‚‰ HTTP/HTTPS é€šä¿¡ã‚’è¡Œã†éš›ã¯ Burp Suite ã‚’çµŒç”±ã—ã¦é€šä¿¡ãŒè¡Œã‚ã‚Œã‚‹ã‚ˆã†ã«ãªã‚Šã¾ã™ã€‚

```bash
$ adb shell
$ su
# iptables -t nat -A OUTPUT -p tcp --destination-port 80 -j DNAT --to-destination 10.0.2.2:8080
# iptables -t nat -A OUTPUT -p tcp --destination-port 443 -j DNAT --to-destination 10.0.2.2:8080
# iptables -t nat -A POSTROUTING -j MASQUERADE
```
ã“ã®éš›ã€ã‚ã‚‰ã‹ã˜ã‚ Burp Suite ã®è¨¼æ˜æ›¸ã‚’ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®è¨¼æ˜æ›¸ã¨ã—ã¦ã§æ§‹ã‚ãªã„ã®ã§ Android ã«ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã—ã¦ãŠã„ã¦ãã ã•ã„ã€‚

ã“ã®çŠ¶æ…‹ã§ã‚¢ãƒ—ãƒªã‚’èµ·å‹•ã—ã¦ã€é©å½“ãªå€¤ã‚’å…¥åŠ›ã—ã¦é€ä¿¡ã™ã‚‹ã¨ã€ä»¥ä¸‹ã®é€šä¿¡ãŒå–å¾—ã§ãã¾ã™ã€‚

![](https://storage.googleapis.com/zenn-user-upload/b83ed7d296b2-20211215.png)

é€šä¿¡ãŒæš—å·åŒ–ã•ã‚Œã¦ãŠã‚Šã€å†…å®¹ãŒèª­ã¿å–ã‚Œã¦ã„ã¾ã›ã‚“ã€‚ä»Šå›ã®ã‚±ãƒ¼ã‚¹ã§ã¯éµãŒã‚ã‚Œã° Burp Extension ã§è§£èª­ãŒå¯èƒ½ã§ã™ãŒã€ä¾‹ãˆã°æ¯å›éµã®å†…å®¹ãŒå¤‰ã‚ã£ãŸã‚Šã€é›£èª­åŒ–ã«ã‚ˆã£ã¦è§£èª­ã«è‹¦ã—ã‚“ã§ã„ã‚‹ã‚ˆã†ãªã‚±ãƒ¼ã‚¹ã‚‚ã‚ã‚‹ã‹ã¨æ€ã‚ã‚Œã¾ã™ã€‚

### Brida æœ‰ã‚Šã®å ´åˆ
#### 1. è¨­å®š
ã‚¢ãƒ—ãƒªã‚’èµ·å‹•ã—ãŸçŠ¶æ…‹ã§ã€Burp Suite ã® Brida ã‚¿ãƒ–ã‹ã‚‰ä»¥ä¸‹ã®è¨­å®šã‚’è¡Œã„ã¾ã™ã€‚ä»¥ä¸‹ Windows æ©Ÿã§ã®è¨­å®šä¾‹ã§ã™ã€‚

![](https://storage.googleapis.com/zenn-user-upload/03c96263a3fa-20211215.png)

è¨­å®šã§åˆ†ã‹ã‚Šã¥ã‚‰ã„ç‚¹ã¨ã—ã¦ã¯ã€

- Pyro server ã‚’èµ·å‹•ã™ã‚‹ã¨ã€Frida JS files folder ã§è¨­å®šã•ã‚ŒãŸãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã« Frida Scripts ãŒå‡ºåŠ›ã•ã‚Œã¾ã™ã€‚
- Frida JS files folder ã«ã¦Select folderï¼ˆFrida JS filesã®ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªæŒ‡å®šï¼‰ã¨Load default JS filesï¼ˆæŒ‡å®šã—ãŸãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã« Frida Scripts ã‚’ç½®ã„ã¦ãã‚Œã‚‹ï¼‰ãŒã‚ã‚‹ã®ã§ã€ä¸¡æ–¹ã‚„ã‚‹ã“ã¨
- Application ID(spawn)/PID(attach) ã¯è¨˜è¼‰ã—ãŸå†…å®¹ã«ã‚ˆã£ã¦ä»¥é™ attach ã™ã‚‹ã‹ spawn ã™ã‚‹ã‹ãŒå¤‰ã‚ã‚Šã¾ã™ã€‚ç”»åƒã§ã¯ spawn ã‚’å‰æã¨ã—ã¦ãŠã‚Šã€ä»¥é™ã®è§£èª¬ã§ã‚‚ spawn ã§è§£èª¬ã‚’è¡Œã„ã¾ã™ã€‚

#### 2. æš—å·åŒ–é–¢æ•°ã‚’æ¢ã™
ã“ã®çŠ¶æ…‹ã§ã€ŒStart serverã€â†’ã€ŒCompile & Spawnã€ã‚’æŠ¼ã—ã¦ã„ã£ã¦ã‚¢ãƒ—ãƒªã‚’èµ·å‹•ã—ã¾ã™ã€‚ä¸Šã®ç”»åƒã«ã¦ã€ŒServer statusã€ã€ŒApplication statusã€ãŒã¨ã‚‚ã« runningï¼ˆç·‘æ–‡å­—ï¼‰ã§ã‚ã‚Œã°æˆåŠŸã§ã™ã€‚

ã“ã®çŠ¶æ…‹ã§ã€ŒGraphical analysisã€ã¸ç§»å‹•ã—ã€å³å´ã®ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã‹ã‚‰ã€ŒLoad Treeã€ã‚’é¸æŠã™ã‚‹ã¨ä»¥ä¸‹ã®ã‚ˆã†ã«ãªã‚Šã¾ã™ã€‚

![](https://storage.googleapis.com/zenn-user-upload/a01f43fa9c52-20211216.png)

ãƒ¡ã‚½ãƒƒãƒ‰ä¸€è¦§ã§ã™ã­ã€‚ä»Šå›ã¯ Kotlin ã‹ã‚‰ç”Ÿæˆã—ã¦ã„ã‚‹ã®ã§ã€Java ã‹ã‚‰ãƒã‚¤ãƒŠãƒªãŒèª­ã¿å–ã‚Œãã†ã§ã™ãŒã€Unityè£½ãªã©ã®å ´åˆã¯ Modules ã« xxx.so ãŒä¸¦ã‚“ã§ã„ã‚‹ã®ã§ã€ãã¡ã‚‰ã‹ã‚‰èª­ã¿å–ã‚Œãã†ã§ã™ã€‚ã“ã“ã‹ã‚‰ã€encrypt/decryptã‚’ã—ã¦ã„ã‚‹é–¢æ•°ã‚’æ¢ã—å‡ºã—ã¾ã™ã€‚

ä»Šå›ã¯ä»¥ä¸‹ã®é–¢æ•°ãŒé–¢ä¿‚ã‚ã‚Šãã†ã§ã™ã€‚æ°—ã«ãªã£ãŸã‚‰å®Ÿéš›ã« Frida ã§ hookã€å®Ÿè¡Œæ™‚ã«å¼•æ•°ã¨è¿”ã‚Šå€¤ã§ã‚‚è¿”ã—ã¦ã¿ã‚‹ã¨ã€Œå®Ÿéš›ã«ä½¿ã‚ã‚Œã¦ã„ã‚‹ã‹ã€ã€Œå®Ÿéš›ã«ä½¿ã‚ã‚Œã¦ã„ã‚‹å ´åˆã€ã©ã®ã‚ˆã†ãªå¼•æ•°ãƒ»è¿”ã‚Šå€¤ãŒå®Ÿéš›ã«å‡ºã‚‹ã‹ã€ã‚’çŸ¥ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚
- `java.lang.String dev.fiord.encrypted_communication_sample.data.LoginDataSource.decrypt(java.lang.String)`
- `java.lang.String dev.fiord.encrypted_communication_sample.data.LoginDataSource.encrypt(java.lang.String)`

#### 3. Burp Extension ã‚’ä½œæˆ
å¯¾è±¡ã®é–¢æ•°ãŒåˆ†ã‹ã£ãŸã‚‰ã€Brida ã®ã€ŒGenerate stubsã€ã¸ç§»å‹•ã—ã€å³å´ã®ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã‹ã‚‰ã€ŒJava Stubã€ã‚’é¸æŠã™ã‚‹ã“ã¨ã§Pyro server ã¨é€šä¿¡ãŒå‡ºæ¥ã‚‹ Burp Extension ã® stub ãŒå‡ºåŠ›ã•ã‚Œã¾ã™ã€‚ã“ã‚Œã‚’å…ƒã« Burp Extension ã‚’ä½œæˆã™ã‚‹å½¢ã§ã™ã€‚ãŒã€ç°¡å˜ãªã‚‚ã®ã§ã‚ã‚Œã°å®Ÿã¯ãã‚“ãªã‚‚ã®ä½œã‚‹å¿…è¦ã¯ç„¡ã‹ã£ãŸã‚Šã—ã¾ã™ã€‚

Bida ã®ã€ŒCustom pluginsã€ã¸ç§»å‹•ã™ã‚‹ã¨ã€ç°¡æ˜“çš„ãª Encode/Deocde ãŒå‡ºæ¥ã‚‹ Burp Extension ã‚’è‡ªå‹•çš„ã«ä½œæˆã™ã‚‹ã“ã¨ãŒå‡ºæ¥ã‚‹ç”»é¢ãŒè¡¨ç¤ºã•ã‚Œã¾ã™ã€‚ã“ã¡ã‚‰ã‚’åˆ©ç”¨ã™ã‚‹ã¨ãƒãƒ¼ã‚³ãƒ¼ãƒ‰ã§ Burp Extension ã‚’ä½œã‚‹ã“ã¨ãŒå‡ºæ¥ã¾ã™ï¼ˆæ­£è¦è¡¨ç¾ã¨ã‹æ™®é€šã«ä½¿ã†ã®ã§ã€ãƒãƒ¼ã‚³ãƒ¼ãƒ‰ã§ã¯ãªã„ã¨æ€ã„ã¾ã™ãŒ...ï¼‰

ä»¥ä¸‹ã®ã‚ˆã†ãªè¨­å®šã‚’ã—ã¾ã™ã€‚

- brida.js ã® `rpc.exports` ã«ä»¥ä¸‹ã‚’è¿½åŠ ã€‚encrypt/decryptãã‚Œãã‚Œã®é–¢æ•°ã‚’å‘¼ã³ã€ãã®è¿”ã‚Šå€¤ã‚’è²°ã†é–¢æ•°ã§ã™ã€‚Fridaã®ä»•æ§˜ã§ `Java.perform` ã®å®Ÿè¡ŒãŒå¿…è¦ã§ã™ãŒã€ã“ã‚Œã¯ asynchronous ã‹ã¤è¿”ã‚Šå€¤ãŒ `return` ã§æ±ºã‚ã‚‰ã‚Œãªã„ãŸã‚ã€ã“ã®ã‚ˆã†ãªæ›¸ãæ–¹ã«ãªã£ã¦ã„ã¾ã™ã€‚

```js:brida.js
 encryptrequest: function(name) {
  return new Promise(function(resolve, reject) {
    Java.perform(function() {
      try {
        var cls = Java.use("dev.fiord.encrypted_communication_sample.data.LoginDataSource");
        var instance = cls.$new();
        var res = instance.encrypt(name).toString();
        console.log(`encrypt: ${name} -> ${res}`);
        resolve(res);
      } catch(e) {
        reject(e);
      }
    });
  });
},
decryptrequest: function(name) {
  return new Promise(function(resolve, reject) {
    Java.perform(function() {
      try {
        var cls = Java.use("dev.fiord.encrypted_communication_sample.data.LoginDataSource");
        var instance = cls.$new();
        var uriDecoded = decodeURIComponent(name);
        var res = instance.decrypt(uriDecoded).toString();
        console.log(`decrypt: ${name} -> ${res}`);
        resolve(res);
      } catch(e) {
        reject(e);
      }
    });
  });
}
```

- Brida ã® Custom plugins ã§ãã‚Œãã‚Œä»¥ä¸‹ã®è¨­å®šã‚’ã™ã‚‹
  - Repeater ç­‰ Burp Suite ã‹ã‚‰é€ã‚‹ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’æš—å·åŒ–ã™ã‚‹ plugin
  ![](https://storage.googleapis.com/zenn-user-upload/5d7cb6508ade-20211221.png)
  - Repeater ç­‰ Burp Suite ã‹ã‚‰é€ã£ãŸãƒªã‚¯ã‚¨ã‚¹ãƒˆã«å¯¾ã™ã‚‹ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã®å¾©å·ã‚’ã™ã‚‹ plugin
  ![](https://storage.googleapis.com/zenn-user-upload/f6d4d1736de1-20211221.png)
  - ã‚¢ãƒ—ãƒªã‹ã‚‰é€ä¿¡ã—ãŸãƒªã‚¯ã‚¨ã‚¹ãƒˆã®å¾©å·ã‚’ã™ã‚‹ pluginï¼ˆProxy ã«ã¦ä½¿ç”¨ï¼‰
  ![](https://storage.googleapis.com/zenn-user-upload/947df6db9d87-20211221.png)
  - ã‚¢ãƒ—ãƒªã‹ã‚‰é€ä¿¡ã—ãŸãƒªã‚¯ã‚¨ã‚¹ãƒˆã«å¯¾ã™ã‚‹ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã®å¾©å·ã‚’ã™ã‚‹ plugin
  ![](https://storage.googleapis.com/zenn-user-upload/28ea4943806d-20211221.png)

ã“ã†ã™ã‚‹ã“ã¨ã§ã€ä»¥ä¸‹ã®ã‚ˆã†ãªæ©æµãŒå¾—ã‚‰ã‚Œã¾ã™ã€‚

- Repeater ç­‰ã§ã¯ Burp ä¸Šã§ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿å†…éƒ¨ãŒå¹³æ–‡ã®ã‚‚ã®ã¨ã—ã¦æ‰±ãˆã‚‹ã‚ˆã†ã«ãªã‚‹ã€‚Burp ã«ã¨ã£ã¦ `name=fiord` ã¨ã—ã¦é€ä¿¡ã—ãŸãƒ‡ãƒ¼ã‚¿ãŒã€plugin ã«ã‚ˆã£ã¦æš—å·åŒ–ã•ã‚ŒãŸçŠ¶æ…‹ã§é€šä¿¡ã‚’è¡Œã„ã€ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã‚‚å¾©å·ã—ã¦å¯è¦–åŒ–ã—ã¦ãã‚Œã‚‹ã€‚
![](https://storage.googleapis.com/zenn-user-upload/4c9a5a928d44-20211221.png)
- Proxyã§ã¯æš—å·åŒ–ã•ã‚Œã¦ã„ã‚‹ã“ã¨ã‚’æŠŠæ¡ã—ã¤ã¤ã€èƒ½å‹•çš„ã«ä¸­èº«ã‚’è¦‹ãŸã„é€šä¿¡ã¯å¾©å·ã™ã‚‹ã“ã¨ãŒå‡ºæ¥ã‚‹ã€‚
![](https://storage.googleapis.com/zenn-user-upload/8d4e1916f3ed-20211221.png)

ã“ã†ã™ã‚‹ã“ã¨ã§ã€é€šä¿¡ã®å†…å®¹ã‚’æŠŠæ¡ã—ãŸä¸Šã§ Active Scan ã«ã‹ã‘ã‚‹ã“ã¨ã‚‚å‡ºæ¥ã¾ã™ã—ã€payload ã‚’ç”¨æ„ã—ã¦ Intruder ã§ã¾ã¨ã‚ã¦ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’æŠ•ã’ã‚‹ã“ã¨ã‚‚å‡ºæ¥ã¾ã™ã€‚

ä»Šå›ã¯ç°¡æ˜“çš„ã«æ‰±ãˆã‚‹ã€ã¨ã„ã†ã“ã¨ã§ Custom plugins ã‚’å–ã‚Šæ‰±ã£ã¦ã¿ã¾ã—ãŸãŒã€Burp Extension ã§ã‚‚ç­‰ä¾¡ã®ã‚‚ã®ã‚’ä½œã‚‹ã“ã¨ãŒå¯èƒ½ã§ã™ã€‚ã¾ãŸã€ä¾‹ãˆã°é€šä¿¡ã®åº¦ã«éµã‚’å¤‰æ›´ã™ã‚‹ã‚ˆã†ãªã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆãƒ»ã‚µãƒ¼ãƒãƒ¼ç­‰ã§ã¯ï¼ˆéµå¤‰æ›´ã®ã‚¿ã‚¤ãƒŸãƒ³ã‚°ç­‰ã«ã‚‚ä¾å­˜ã—ã¾ã™ãŒï¼‰ Custom plugins ã®ã¿ã§ã¯é›£ã—ã„ã¨æ€ã‚ã‚Œã¾ã™ã®ã§ã€ãã®ã‚ˆã†ãªã‚±ãƒ¼ã‚¹ã«å¯¾ã—ã¦ã¯ Burp Extension ã®æŸ”è»Ÿæ€§ã‚’æ´»ç”¨ã™ã‚‹ã“ã¨ã«ãªã‚Šãã†ã§ã™ã€‚

# ã¾ã¨ã‚
Brida ã¯ Burp Suite ã§æ‰‹ãŒå±Šãã«ãã„ã€Œç‹¬è‡ªæš—å·åŒ–ã•ã‚ŒãŸé€šä¿¡ã€ã«å¯¾ã—ã¦ Reverse Engineering ã®æ‰‹é–“ã‚’çœãã¤ã¤ã€Frida ã®å¼·ã¿ã‚’ä½¿ã£ã¦ Burp Suite ã§æ‰±ãˆã‚‹å½¢å¼ã«ç°¡å˜ã«å¤‰ãˆã‚‹ã“ã¨ãŒå‡ºæ¥ã‚‹ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã§ã—ãŸã€‚ã¾ã ç™ºå±•é€”ä¸Šï¼ˆæœ€æ–°ç‰ˆãŒv0.5ï¼‰ã¨ã„ã†ã“ã¨ã‚‚ã‚ã‚Šã€å›°ã‚‹ã“ã¨ã‚‚ã‚ã‚‹ã‹ã¨æ€ã„ã¾ã™ãŒã€ãœã²ä½¿ã£ã¦ã¿ã¦ãã ã•ã„ï¼

ã“ã®è¨˜äº‹ã‚’èª­ã‚“ã§ã€Œé¢ç™½ã‹ã£ãŸã€ã€Œå­¦ã³ãŒã‚ã£ãŸã€ã¨æ€ã£ã¦ã„ãŸã ã‘ãŸæ–¹ã€ã‚ˆã‚ã—ã‘ã‚Œã° Twitter ã‚„ã¯ã¦ãªãƒ–ãƒƒã‚¯ãƒãƒ¼ã‚¯ã«ã¦ã‚³ãƒ¡ãƒ³ãƒˆã‚’ãŠé¡˜ã„ã—ã¾ã™ï¼

ã¾ãŸã€[DeNA å…¬å¼ Twitter ã‚¢ã‚«ã‚¦ãƒ³ãƒˆ @DeNAxTech](https://twitter.com/DeNAxTech) ã§ã¯ã€Blog è¨˜äº‹ã ã‘ã§ãªãè‰²ã€…ãªå‹‰å¼·ä¼šã§ã®ç™»å£‡è³‡æ–™ã‚‚ç™ºä¿¡ã—ã¦ã„ã‚‹ã®ã§ãœã²ãƒ•ã‚©ãƒ­ãƒ¼ã—ã¦ä¸‹ã•ã„ã€‚

### å‚è€ƒ
- [Brida Wiki](https://github.com/federicodotta/Brida/wiki): ã‹ãªã‚Šä¸å¯§ã«è§£èª¬ãŒã‚ã‚Šã¾ã™ã€‚ãƒãƒ¼ã‚¸ãƒ§ãƒ³å‘¨ã‚Šã¯ã‚ˆã Issue ã«ä¸ŠãŒã£ã¦ã„ã‚‹æ°—ãŒã™ã‚‹ã®ã§å›°ã£ãŸã‚‰å‚è€ƒã«ã€‚
- [#HITB2018AMS D1T1 - Brida: When Burp Suite meets Frida - Federico Dotta & Piergiovanni Cipolloni](https://www.youtube.com/watch?v=wPepicuHDzs)
  - [ç™ºè¡¨è³‡æ–™ã¨æ€ã‚ã—ãã‚‚ã®](https://www.hackinbo.it/slides/1508354139_HackInBo%202017%20Winter%20Edition%20-%20Federico%20Dotta%20-%20Advanced%20mobile%20penetration%20testing%20with%20Brida%20-%20141017.pdf)

