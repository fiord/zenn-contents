---
title: "Ã¥ngstromCTF 2021 - Circle of Trust"
emoji: "ğŸ”¥"
type: "tech" # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics: ["CTF", "Crypto", "Med"]
published: true
---

### å•é¡Œæ¦‚è¦
> Clam created a 1337 secret sharing scheme for his 1337 trio of friends. Can you crack it?
>
> [output](https://files.actf.co/d6b852e2736b26aa9b0e6668e1c572e90cf0f6691c64519a95df5cec001eef13/output.txt) [source](https://files.actf.co/629aefee40e9ff9e40e4fe797abcc820ded6686d2225e71bcaf9142ee1cffd64/gen.py)

```python:gen.py
import random
import secrets
import math
from decimal import Decimal, getcontext
from Crypto.Cipher import AES

BOUND = 2 ** 128
MULT = 10 ** 10

getcontext().prec = 50

def nums(a):
    b = Decimal(random.randint(-a * MULT, a * MULT)) / MULT
    c = (a ** 2 - b ** 2).sqrt()
    if random.randrange(2):
        c *= -1
    return (b, c)


with open("flag", "r") as f:
    flag = f.read().strip().encode("utf8")

diff = len(flag) % 16
if diff:
    flag += b"\x00" * (16 - diff)

keynum = secrets.randbits(128)
ivnum = secrets.randbits(128)

key = int.to_bytes(keynum, 16, "big")
iv = int.to_bytes(ivnum, 16, "big")

x = Decimal(random.randint(1, BOUND * MULT)) / MULT
for _ in range(3):
    (a, b) = nums(x)
    print(f"({keynum + a}, {ivnum + b})")

cipher = AES.new(key, AES.MODE_CBC, iv=iv)
enc = cipher.encrypt(flag)
print(enc.hex())
```

ä¸‰å¹³æ–¹ã‚’ä½¿ã£ãŸé¢ç™½ã‚ã®å•é¡Œã§ã™ã€‚

### è§£èª¬
ãƒ©ãƒ³ãƒ€ãƒ ã«ç”Ÿæˆã•ã‚ŒãŸ`x`ã¨ã„ã†å¤‰æ•°ã‹ã‚‰ã€`a`,`b`ãŒ$a^2+b^2 = x^2$ã‚’æº€ãŸã™ã‚ˆã†ã«$3$ãƒšã‚¢ç”Ÿæˆã•ã‚Œã¾ã™ã€‚ãŸã ã€ã“ã®`a`,`b`ã«ãã‚Œãã‚Œ`key`,`iv`ãŒãƒã‚¤ã‚ºã¨ã—ã¦è¿½åŠ ã•ã‚Œã€ãã‚‚ãã‚‚çŸ¥ã‚ŠãŸã„æƒ…å ±ã¯`key`,`iv`ã®æ–¹ã§ã™ã€‚

ã“ã“ã‹ã‚‰æ€ã„ã£ãã‚Šæ•°å¼ã‚’å¼„ã‚‹ãƒ‘ãƒ¼ãƒˆã§ã™ã€‚

1. ä¸ãˆã‚‰ã‚ŒãŸãƒšã‚¢ã®æ•°å€¤ï¼ˆ`a+key`,`b+iv`ï¼‰ã‚’$x, y$ã¨ã—ã¾ã™ã€‚$x = a + key$ã€$y = b + iv$ã§ã€$x, y$ã¯æ—¢çŸ¥ã§ã™ã€‚
2. $x,y$ã¯3ãƒšã‚¢ä¸ãˆã‚‰ã‚Œã‚‹ã®ã§ã€$x_i, y_i$ã¨ã„ã†è¡¨è¨˜ã§åŒºåˆ¥ã—ã¾ã™ã€‚åŒæ§˜ã«$a_i, b_i$ã‚‚ä½¿ç”¨ã—ã¾ã™ã€‚
3. $a, b$ã«ã¤ã„ã¦$a_1^2 + b_1^2 = a_2^2 + b_2^2 = a_3^2 + b_3^2$ãŒæˆç«‹ã—ã¾ã™ã€‚
4. 3ã«$a=x-key, b=y-iv$ã‚’ä»£å…¥ã™ã‚‹ã¨ã€ä»¥ä¸‹ã®ã‚ˆã†ãªå¼ã«ãªã‚Šã¾ã™ã€‚

$$
\begin{aligned}
a_1^2 + b_1^2 &= a_2^2 + b_2^2\\
(x_1 - key)^2 + (y_1 - iv)^2 &= (x_2 - key)^2 + (y_2 - iv)^2\\
2(x_1 - x_2) \times {\rm key} + 2(y_1 - y_2) \times {\rm iv} &= (x_1^2 - x_2^2) + (y_1^2 - y_2^2)
\end{aligned}
$$

5. ã“ã®ã‚ˆã†ã«å¤‰æ•°`key`, `iv`ã‚’ç”¨ã„ãŸ1æ¬¡æ–¹ç¨‹å¼ã«ãªã‚Šã¾ã—ãŸã€‚ã¨ã“ã‚ã§$(x_2, y_2), (x_3, y_3)$ã‚’ç”¨ã„ã¦ã‚‚ã†1ã¤å¼ã‚’ä½œã‚‹ã“ã¨ãŒå‡ºæ¥ã¾ã™ã€‚ã“ã‚Œã‚‰ã‚’é€£ç«‹ã•ã›ã¦è§£ãã“ã¨ã§ã€`key`ã¨`iv`ã®å€¤ã‚’æ±‚ã‚ã‚‹ã“ã¨ãŒå‡ºæ¥ã¾ã™ã€‚

`key`ã€`iv`ã‚’æ±‚ã‚ã‚‹ã“ã¨ã§AESã®å¾©å·ãŒå‡ºæ¥ã¾ã™ã€‚

```python:solve.py
from decimal import *
from Crypto.Util.number import *
from Crypto.Cipher import AES

getcontext().prec = 128
MULT = 10 ** 10
bc = [
    (Decimal("45702021340126875800050711292004769456.2582161398"), Decimal("310206344424042763368205389299416142157.00357571144")),
    (Decimal("55221733168602409780894163074078708423.359152279"), Decimal("347884965613808962474866448418347671739.70270575362")),
    (Decimal("14782966793385517905459300160069667177.5906950984"), Decimal("340240003941651543345074540559426291101.69490484699")),
]
c = bytes.fromhex("838371cd89ad72662eea41f79cb481c9bb5d6fa33a6808ce954441a2990261decadf3c62221d4df514841e18c0b47a76")

equations = [
        (2 * (bc[0][0] - bc[1][0]), 2 * (bc[0][1] - bc[1][1]), (bc[0][0] ** 2 - bc[1][0] ** 2) + (bc[0][1] ** 2 - bc[1][1] ** 2)),
        (2 * (bc[1][0] - bc[2][0]), 2 * (bc[1][1] - bc[2][1]), (bc[1][0] ** 2 - bc[2][0] ** 2) + (bc[1][1] ** 2 - bc[2][1] ** 2))
    ]

xn = (equations[0][2] * equations[1][1] - equations[0][1] * equations[1][2])
xd = (equations[0][0] * equations[1][1] - equations[0][1] * equations[1][0])
yn = (equations[0][2] * equations[1][0] - equations[0][0] * equations[1][2])
yd = (equations[0][1] * equations[1][0] - equations[0][0] * equations[1][1])
print("xn:", xn)
print("xd:", xd)
print("mod:", xn % xd)
print("yn:", yn)
print("yd:", yd)
print("mod:", yn % yd)

x = int(xn / xd) + 1
y = int(yn / yd)

key = int.to_bytes(x, 16, "big")
iv = int.to_bytes(y, 16, "big")
cipher = AES.new(key, AES.MODE_CBC, iv=iv)
dec = cipher.decrypt(c)
print(dec)
```